local internalNpcName = "Lord Varys"
local npcType = Game.createNpcType(internalNpcName)
local npcConfig = {}

npcConfig.name = internalNpcName
npcConfig.description = "the Master of Whispers"

npcConfig.health = 100
npcConfig.maxHealth = npcConfig.health

npcConfig.walkInterval = 2500
npcConfig.walkRadius = 7

npcConfig.outfit = {
	lookType = 57,
}

npcConfig.flags = {
	floorchange = true,
}

local keywordHandler = KeywordHandler:new()
local npcHandler = NpcHandler:new(keywordHandler)

-- =========================
-- EVENTOS PADRÃO
-- =========================
npcType.onThink = function(npc, interval)
	npcHandler:onThink(npc, interval)
end

npcType.onAppear = function(npc, creature)
	npcHandler:onAppear(npc, creature)
end

npcType.onDisappear = function(npc, creature)
	npcHandler:onDisappear(npc, creature)
end

npcType.onMove = function(npc, creature, fromPosition, toPosition)
	npcHandler:onMove(npc, creature, fromPosition, toPosition)
end

npcType.onSay = function(npc, creature, type, message)
	npcHandler:onSay(npc, creature, type, message)
end

npcType.onCloseChannel = function(npc, creature)
	npcHandler:onCloseChannel(npc, creature)
end

npcHandler:setMessage(MESSAGE_GREET, "Shhh... nem todos devem me ouvir, |PLAYERNAME|.")
npcHandler:setMessage(MESSAGE_FAREWELL, "O silêncio guarda mais verdades do que o barulho.")
npcHandler:setMessage(MESSAGE_WALKAWAY, "Alguns segredos não gostam de despedidas.")

npcHandler:addModule(FocusModule:new(), npcConfig.name, true, true, true)

-- =========================
-- CONFIGS DE LORE / QUEST
-- =========================
local SECRET_WORD = "sussurro"
local STORAGE_VARYS = 90100
local STORAGE_REI_CAIDO = 90101

-- =========================
-- DIÁLOGOS CANÔNICOS
-- =========================
local varysDialogues = {
	"Nem todos os caminhos são visíveis a olho nu, aventureiro. Já olhou atrás das paredes da cidade?",
	"O senhor das chamas desperta apenas sob a lua cheia. Mas cuidado, ele não perdoa os impacientes.",
	"Dizem que um festival raro está próximo… mas apenas os atentos poderão aproveitá-lo.",
	"Se deseja glória, busque o Desafio do Rei Caído. Poucos voltaram para contar a história."
}

-- =========================
-- PALAVRA SECRETA / QUEST LOG
-- =========================
keywordHandler:addKeyword({SECRET_WORD}, function(player, npc)
	if player:getStorageValue(STORAGE_VARYS) < 1 then
		player:setStorageValue(STORAGE_VARYS, 1)
		npcHandler:say(
			"Então você conhece o sussurro... Observe seu diário. Agora fazemos parte da mesma história.",
			npc, player
		)
	else
		npcHandler:say("Os sussurros ainda ecoam. Pergunte com cuidado.", npc, player)
	end
end)

-- =========================
-- QUEST / SEGREDOS
-- =========================
keywordHandler:addKeyword({"quest", "segredo", "segredos"}, function(player, npc)
	if player:getStorageValue(STORAGE_VARYS) < 1 then
		npcHandler:say("Palavras vazias não abrem bocas seladas.", npc, player)
		return
	end

	local level = player:getLevel()

	if level < 50 then
		npcHandler:say("Você ainda escuta pouco. Volte quando o mundo pesar mais.", npc, player)
	elseif level < 150 then
		npcHandler:say(varysDialogues[math.random(#varysDialogues)], npc, player)
	else
		npcHandler:say(
			"Os antigos caminhos despertam. Onde reis caíram, o destino aguarda.",
			npc, player
		)
	end
end)

-- =========================
-- BOSSES
-- =========================
keywordHandler:addKeyword({"boss", "bosses"}, function(player, npc)
	if player:getLevel() < 100 then
		npcHandler:say("Alguns nomes não devem ser ditos por iniciantes.", npc, player)
		return
	end

	npcHandler:say(
		"O Senhor das Chamas surge apenas sob lua cheia. A pressa é a sentença.",
		npc, player
	)
end)

-- =========================
-- EVENTOS
-- =========================
keywordHandler:addKeyword({"event", "eventos"}, function(player, npc)
	npcHandler:say(
		"O mundo se move em ciclos. Os atentos sempre chegam antes.",
		npc, player
	)
end)

-- =========================
-- DESAFIO DO REI CAÍDO
-- =========================
keywordHandler:addKeyword({"rei", "caido", "desafio"}, function(player, npc)
	if player:getStorageValue(STORAGE_REI_CAIDO) ~= 1 then
		npcHandler:say(
			"Se deseja desafiar o Rei Caído, prepare-se. Nem todos retornam.",
			npc, player
		)
	else
		npcHandler:say(
			"Você já caminhou onde reis tombaram. Poucos podem dizer isso.",
			npc, player
		)
	end
end)

npcType:register(npcConfig)
