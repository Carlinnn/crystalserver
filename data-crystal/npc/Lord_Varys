local internalNpcName = "Lord Varys"
local npcType = Game.createNpcType(internalNpcName)
local npcConfig = {}

npcConfig.name = internalNpcName
npcConfig.description = "the Master of Whispers"

npcConfig.health = 100
npcConfig.maxHealth = npcConfig.health

npcConfig.walkInterval = 2500
npcConfig.walkRadius = 7

npcConfig.outfit = {
	lookType = 57,
}

npcConfig.flags = {
	floorchange = true,
}

local keywordHandler = KeywordHandler:new()
local npcHandler = NpcHandler:new(keywordHandler)

-- =========================
-- EVENTOS PADRÃO
-- =========================
npcType.onThink = function(npc, interval)
	npcHandler:onThink(npc, interval)
end

npcType.onAppear = function(npc, creature)
	npcHandler:onAppear(npc, creature)
end

npcType.onDisappear = function(npc, creature)
	npcHandler:onDisappear(npc, creature)
end

npcType.onMove = function(npc, creature, fromPosition, toPosition)
	npcHandler:onMove(npc, creature, fromPosition, toPosition)
end

npcType.onSay = function(npc, creature, type, message)
	npcHandler:onSay(npc, creature, type, message)
end

npcType.onCloseChannel = function(npc, creature)
	npcHandler:onCloseChannel(npc, creature)
end

npcHandler:setMessage(MESSAGE_GREET, "Shhh... nem todos devem me ouvir, |PLAYERNAME|.")
npcHandler:setMessage(MESSAGE_FAREWELL, "O silêncio guarda mais verdades do que o barulho.")
npcHandler:setMessage(MESSAGE_WALKAWAY, "Alguns segredos não gostam de despedidas.")

npcHandler:addModule(FocusModule:new(), npcConfig.name, true, true, true)

-- =========================
-- CONFIGS DE LORE / QUEST
-- =========================
local SECRET_WORD = "sussurro"
local STORAGE_VARYS = 90100
local STORAGE_REI_CAIDO = 90101

-- =========================
-- FRASES FINAIS CANÔNICAS
-- =========================
local endingQuotes = {
	"No Gordons, o poder não está nas espadas… está em quem sabe quando usá-las.",
	"Meus pequenos pássaros voam até os lugares onde nem a magia ousa entrar.",
	"Há heróis famosos neste mundo… e traidores ainda mais bem escondidos.",
	"Nem todo inimigo vem armado. Alguns vêm sorrindo.",
	"O reino sobrevive não pela força, mas pela informação.",
	"Em Gordons, quem fala demais costuma desaparecer cedo.",
	"As guerras começam muito antes do primeiro golpe.",
	"A verdade é valiosa… por isso quase nunca é gratuita.",
	"Observe quem evita o olhar — ali costuma morar o perigo.",
	"Quando todos correm para a batalha, alguém precisa observar das sombras."
}

local function sayWithEnd(npc, player, text)
	local ending = endingQuotes[math.random(#endingQuotes)]
	npcHandler:say(text .. "\n\n" .. ending, npc, player)
end

-- =========================
-- DIÁLOGOS CANÔNICOS
-- =========================
local varysDialogues = {
	"Nem todos os caminhos são visíveis a olho nu, aventureiro. Já olhou atrás das paredes da cidade?",
	"O senhor das chamas desperta apenas sob a lua cheia. Mas cuidado, ele não perdoa os impacientes.",
	"Dizem que um festival raro está próximo… mas apenas os atentos poderão aproveitá-lo.",
	"Se deseja glória, busque o Desafio do Rei Caído. Poucos voltaram para contar a história."
}

-- =========================
-- PALAVRA SECRETA
-- =========================
keywordHandler:addKeyword({SECRET_WORD}, function(player, npc)
	if player:getStorageValue(STORAGE_VARYS) < 1 then
		player:setStorageValue(STORAGE_VARYS, 1)
		sayWithEnd(npc, player,
			"Então você conhece o sussurro... Observe seu diário. Agora fazemos parte da mesma história."
		)
	else
		sayWithEnd(npc, player, "Os sussurros ainda ecoam. Pergunte com cuidado.")
	end
end)

-- =========================
-- QUEST / SEGREDOS
-- =========================
keywordHandler:addKeyword({"quest", "segredo", "segredos"}, function(player, npc)
	if player:getStorageValue(STORAGE_VARYS) < 1 then
		sayWithEnd(npc, player, "Palavras vazias não abrem bocas seladas.")
		return
	end

	local level = player:getLevel()

	if level < 50 then
		sayWithEnd(npc, player, "Você ainda escuta pouco. Volte quando o mundo pesar mais.")
	elseif level < 150 then
		sayWithEnd(npc, player, varysDialogues[math.random(#varysDialogues)])
	else
		sayWithEnd(npc, player,
			"Os antigos caminhos despertam. Onde reis caíram, o destino aguarda."
		)
	end
end)

-- =========================
-- CACHOEIRA (NOVO)
-- =========================
keywordHandler:addKeyword({"cachoeira"}, function(player, npc)
	sayWithEnd(npc, player,
		"Há quem diga que após as montanhas, depois do dragão, existe uma trilha esquecida. "
		.. "Ela leva ao topo de uma grande cachoeira, onde uma antiga estátua observa o mundo em silêncio. "
		.. "Somente os corajosos ousam pular dali… e aqueles que sobrevivem encontram algo. "
		.. "Ainda não sei o que é. Mas meus pequenos pássaros logo irão descobrir."
	)
end)

-- =========================
-- BOSSES
-- =========================
keywordHandler:addKeyword({"boss", "bosses"}, function(player, npc)
	if player:getLevel() < 100 then
		sayWithEnd(npc, player, "Alguns nomes não devem ser ditos por iniciantes.")
		return
	end

	sayWithEnd(npc, player,
		"O Senhor das Chamas surge apenas sob lua cheia. A pressa é a sentença."
	)
end)

-- =========================
-- EVENTOS
-- =========================
keywordHandler:addKeyword({"event", "eventos"}, function(player, npc)
	sayWithEnd(npc, player,
		"O mundo se move em ciclos. Os atentos sempre chegam antes."
	)
end)

-- =========================
-- DESAFIO DO REI CAÍDO
-- =========================
keywordHandler:addKeyword({"rei", "caido", "desafio"}, function(player, npc)
	if player:getStorageValue(STORAGE_REI_CAIDO) ~= 1 then
		sayWithEnd(npc, player,
			"Se deseja desafiar o Rei Caído, prepare-se. Nem todos retornam."
		)
	else
		sayWithEnd(npc, player,
			"Você já caminhou onde reis tombaram. Poucos podem dizer isso."
		)
	end
end)

npcType:register(npcConfig)
